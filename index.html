<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>House Renovation Cost Calculator (Japan)</title>
  <style>
    :root{
      --bg:#0b1326; --panel:#0e172a; --muted:#334155; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --good:#34d399; --warn:#fbbf24; --bad:#f87171;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#060b1a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{padding:24px 16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
    .h1{font-size:clamp(18px,2.4vw,26px);font-weight:700;letter-spacing:.2px}
    .sub{opacity:.85;font-size:12px}
    main{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:20px auto;padding:0 12px 32px}
    @media(min-width:980px){main{grid-template-columns:420px 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #1f2937;background:radial-gradient(1200px 1200px at -10% -50%,rgba(34,211,238,.15),transparent 40%),linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));font-size:15px;letter-spacing:.3px}
    .body{padding:16px;display:grid;gap:14px}
    label{font-size:12px;opacity:.9}
    input,select,button,textarea{font-family:inherit}
    .row{display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:end}
    .row .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row input[type="number"], .row input[type="text"]{width:100%;background:#0a1224;color:var(--text);border:1px solid #253049;border-radius:10px;padding:10px}
    .row select{width:100%;background:#0a1224;color:var(--text);border:1px solid #253049;border-radius:10px;padding:10px}
    .row .unit{font-size:12px;opacity:.8;margin-bottom:10px}
    .muted{opacity:.8;font-size:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tog{display:flex;align-items:center;gap:8px}
    .tog input{accent-color:var(--accent)}
    .btn{background:linear-gradient(180deg,var(--accent),#12b8d2);border:none;color:#00222a;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.secondary{background:linear-gradient(180deg,#64748b,#475569);color:#e5e7eb}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#101a33;border:1px solid #233055;color:#bbdefb;padding:6px 8px;border-radius:999px;font-size:11px}
    .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(min-width:700px){.kpi{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .kpi .tile{background:linear-gradient(180deg,rgba(167,139,250,.1),rgba(34,211,238,.08));border:1px solid #223051;border-radius:14px;padding:12px}
    .kpi .tile .label{font-size:12px;opacity:.85}
    .kpi .tile .val{font-size:20px;font-weight:800;margin-top:4px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed #27324a;font-size:13px}
    th{text-align:left;opacity:.9}
    tfoot td{font-weight:800}
    .right{text-align:right}
    .pill{padding:.2rem .5rem;border-radius:999px;background:#0e1a34;font-size:11px;border:1px solid #283659;cursor:pointer}
    .footer{padding:14px 16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;border-top:1px solid #1f2937;background:linear-gradient(0deg,rgba(255,255,255,.04),transparent)}
    a{color:#8ddcff}
    .disclaimer{font-size:11px;opacity:.75}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="h1">House Renovation Cost Calculator (Japan)</div>
      <div class="sub">Estimate renovation CapEx for an existing detached house (戸建て). All figures in JPY. Lower default unit costs than commercial/ryokan.</div>
    </div>
    <div class="badge" id="buildInfo">v1.0 • Client‑side only</div>
  </header>

  <main>
    <!-- INPUTS -->
    <section class="card">
      <h2>Inputs</h2>
      <div class="body">

        <div class="row">
          <div>
            <label>Total floor area (m²)</label>
            <input type="number" id="area" value="120" min="1" step="1" />
          </div>
          <div>
            <label class="unit">Assumption</label>
            <div class="muted">Use measured 延床 (GFA). Typical JP detached house is 90–140 m².</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="row">
            <div>
              <label>Scope level</label>
              <select id="scope">
                <option value="lite">Lite (cosmetic, non‑structural)</option>
                <option value="mid" selected>Mid (partial gut, systems refresh)</option>
                <option value="full">Full gut (deep energy or replan)</option>
              </select>
            </div>
            <div>
              <label>Regional cost factor</label>
              <select id="region">
                <option value="0.90">Rural (0.90×)</option>
                <option value="0.95">Small town (0.95×)</option>
                <option value="1.00" selected>Regional city (1.00×)</option>
                <option value="1.10">Metro ring (1.10×)</option>
                <option value="1.25">Central Tokyo/Osaka/Kyoto (1.25×)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Target use</label>
              <select id="target">
                <option value="personal" selected>Personal residence / 2nd home</option>
                <option value="minpaku">Adds STVR/民泊 compliance (alarms, egress)</option>
              </select>
            </div>
            <div>
              <label>FX (optional, USD/JPY)</label>
              <input type="number" id="fx" value="155" step="0.01" />
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="tog"><input type="checkbox" id="eq"><label>Seismic retrofit (耐震改修)</label></div>
          <div class="tog"><input type="checkbox" id="roof" checked><label>Roof repair / re‑roof</label></div>
          <div class="tog"><input type="checkbox" id="mep" checked><label>MEP (plumbing/electrical/HVAC)</label></div>
          <div class="tog"><input type="checkbox" id="bath" checked><label>Bathroom upgrade</label></div>
          <div class="tog"><input type="checkbox" id="kitchen" checked><label>Kitchen upgrade</label></div>
          <div class="tog"><input type="checkbox" id="fire"><label>Fire safety (residential alarms/egress)</label></div>
          <div class="tog"><input type="checkbox" id="ext" checked><label>Exterior envelope (siding/paint/windows)</label></div>
          <div class="tog"><input type="checkbox" id="int" checked><label>Interior finishes (flooring/doors/walls)</label></div>
          <div class="tog"><input type="checkbox" id="insul" checked><label>Insulation/airtightness upgrade</label></div>
          <div class="tog"><input type="checkbox" id="septic"><label>Septic/wastewater system upgrade</label></div>
          <div class="tog"><input type="checkbox" id="solar"><label>Solar PV (4–5kW)</label></div>
          <div class="tog"><input type="checkbox" id="carport"><label>Carport / parking works</label></div>
        </div>

        <div class="grid-2">
          <div class="row">
            <div>
              <label>Design + permits (%)</label>
              <input type="number" id="profPct" value="8" step="0.5" />
            </div>
            <div>
              <label>Contingency (%)</label>
              <input type="number" id="contPct" value="15" step="0.5" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>FF&E / Furnishings (JPY)</label>
              <input type="number" id="ffne" value="1500000" step="50000" />
            </div>
            <div>
              <label>Misc. approvals (JPY)</label>
              <input type="number" id="approvals" value="200000" step="50000" />
            </div>
          </div>
        </div>

        <div class="row">
          <div class="inline">
            <button class="btn" id="calc">Calculate</button>
            <button class="btn secondary" id="reset">Reset</button>
            <button class="btn secondary" id="share">Share link</button>
            <button class="btn secondary" id="save">Save preset</button>
            <select id="presets"></select>
          </div>
          <div class="muted">All numbers are planning estimates. Get quotes from licensed 建設業者. Toggle items and change unit costs below.</div>
        </div>

      </div>
      <div class="footer">
        <span class="disclaimer">Typical unit‑cost bands (detached house): Lite ¥50–100k/m² • Mid ¥100–180k/m² • Full ¥180–280k/m². Seismic ¥30–70k/m². Fire (residential) ¥3–10k/m².</span>
      </div>
    </section>

    <!-- OUTPUTS -->
    <section class="card">
      <h2>Estimate</h2>
      <div class="body">
        <div class="kpi">
          <div class="tile"><div class="label">Base construction</div><div class="val" id="kBase">–</div></div>
          <div class="tile"><div class="label">Add‑ons & systems</div><div class="val" id="kAdd">–</div></div>
          <div class="tile"><div class="label">Soft costs (design/permits)</div><div class="val" id="kSoft">–</div></div>
          <div class="tile"><div class="label">Contingency</div><div class="val" id="kCont">–</div></div>
        </div>

        <table id="tbl">
          <thead>
            <tr><th>Component</th><th class="right">Unit cost</th><th class="right">Qty</th><th class="right">Line total (JPY)</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="3" class="right">Subtotal (hard + add‑ons)</td><td class="right" id="subHard">–</td></tr>
            <tr><td colspan="3" class="right">Soft costs (design/permits)</td><td class="right" id="soft">–</td></tr>
            <tr><td colspan="3" class="right">FF&E / Furnishings</td><td class="right" id="ff">–</td></tr>
            <tr><td colspan="3" class="right">Misc. approvals</td><td class="right" id="appr">–</td></tr>
            <tr><td colspan="3" class="right">Contingency</td><td class="right" id="cont">–</td></tr>
            <tr><td colspan="3" class="right">Total (JPY)</td><td class="right" id="total">–</td></tr>
            <tr><td colspan="3" class="right">Total (USD)</td><td class="right" id="totalUSD">–</td></tr>
          </tfoot>
        </table>

        <div class="muted">Click a unit‑cost cell to override it inline. All calculations run locally in your browser.</div>
      </div>
    </section>

    <!-- UNIT COSTS PANEL -->
    <section class="card">
      <h2>Unit‑Cost Assumptions</h2>
      <div class="body">
        <div class="grid-2">
          <div>
            <div class="muted">Defaults reflect recent bids for residential renovations (rural→metro). Adjust to your contractor, condition, and goals.</div>
          </div>
          <div class="right"><span class="pill" id="restore">Restore defaults</span></div>
        </div>
        <table id="ucTable">
          <thead><tr><th>Item</th><th class="right">JPY per m² or fixed</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    // ------- Default unit costs (JPY) for house -------
    const DEFAULTS = {
      base_lite_per_m2: 80000,
      base_mid_per_m2: 140000,
      base_full_per_m2: 240000,
      seismic_per_m2: 50000,
      mep_per_m2: 30000,
      ext_per_m2: 25000,
      int_per_m2: 40000,
      fire_per_m2: 8000,
      insul_per_m2: 15000,
      roof_fixed: 1400000,
      bath_fixed: 1800000,
      kitchen_fixed: 1500000,
      septic_fixed: 1200000,
      solar_fixed: 1300000,
      carport_fixed: 600000
    };

    // ------- State -------
    let UC = {...DEFAULTS};

    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);

    function yen(x){ return x.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}); }
    function usd(x, fx){ if(!fx || fx<=0) return '—'; return x/fx; }

    function readInputs(){
      return {
        area: +$('#area').value || 0,
        scope: $('#scope').value,
        region: +$('#region').value,
        target: $('#target').value,
        eq: $('#eq').checked,
        roof: $('#roof').checked,
        mep: $('#mep').checked,
        bath: $('#bath').checked,
        kitchen: $('#kitchen').checked,
        fire: $('#fire').checked,
        ext: $('#ext').checked,
        int: $('#int').checked,
        insul: $('#insul').checked,
        septic: $('#septic').checked,
        solar: $('#solar').checked,
        carport: $('#carport').checked,
        profPct: (+$('#profPct').value || 0)/100,
        contPct: (+$('#contPct').value || 0)/100,
        ffne: +$('#ffne').value || 0,
        approvals: +$('#approvals').value || 0,
        fx: +$('#fx').value || 0,
      }
    }

    function line(name, unitCost, qty, isPerM2){
      const total = (isPerM2? unitCost*qty : unitCost);
      return {name, unitCost, qty: isPerM2? qty: 1, total, isPerM2};
    }

    function complianceMultiplier(target){
      // Personal baseline; Minpaku adds small cost pressure
      if(target==='minpaku') return 1.05;
      return 1.00;
    }

    function calc(){
      const I = readInputs();
      const basePerM2 = I.scope==='lite'? UC.base_lite_per_m2 : (I.scope==='mid'? UC.base_mid_per_m2 : UC.base_full_per_m2);
      const rows = [];

      const region = I.region;
      const comp = complianceMultiplier(I.target);

      rows.push(line(`Base construction (${I.scope})`, basePerM2*region*comp, I.area, true));

      if(I.eq) rows.push(line('Seismic retrofit (耐震)', UC.seismic_per_m2*region, I.area, true));
      if(I.mep) rows.push(line('MEP (plumbing/electrical/HVAC)', UC.mep_per_m2*region, I.area, true));
      if(I.ext) rows.push(line('Exterior envelope (siding/windows/paint)', UC.ext_per_m2*region, I.area, true));
      if(I.int) rows.push(line('Interior finishes (flooring/doors/walls)', UC.int_per_m2*region, I.area, true));
      if(I.insul) rows.push(line('Insulation / airtightness upgrade', UC.insul_per_m2*region, I.area, true));
      if(I.fire) rows.push(line('Fire safety (residential alarms/egress)', UC.fire_per_m2*region* (I.target==='minpaku'?1.1:1), I.area, true));
      if(I.roof) rows.push(line('Roof repair / re-roof (fixed)', UC.roof_fixed*region, 1, false));
      if(I.bath) rows.push(line('Bathroom upgrade (fixed)', UC.bath_fixed*region, 1, false));
      if(I.kitchen) rows.push(line('Kitchen upgrade (fixed)', UC.kitchen_fixed*region, 1, false));
      if(I.septic) rows.push(line('Septic / wastewater system (fixed)', UC.septic_fixed*region, 1, false));
      if(I.solar) rows.push(line('Solar PV (4–5kW, fixed)', UC.solar_fixed*region, 1, false));
      if(I.carport) rows.push(line('Carport / parking works (fixed)', UC.carport_fixed*region, 1, false));

      const subHard = rows.reduce((a,r)=>a+r.total,0);
      const soft = subHard * I.profPct;
      const contingency = (subHard + soft + I.ffne + I.approvals) * I.contPct;
      const total = subHard + soft + I.ffne + I.approvals + contingency;

      const base = rows[0]?.total || 0;
      const addons = subHard - base;
      $('#kBase').textContent = yen(base);
      $('#kAdd').textContent  = yen(addons);
      $('#kSoft').textContent = yen(soft);
      $('#kCont').textContent = yen(contingency);

      const tbody = $('#tbl tbody');
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const tdN = document.createElement('td'); tdN.textContent = r.name;
        const tdU = document.createElement('td'); tdU.className='right editable'; tdU.textContent = r.isPerM2? yen(r.unitCost) + ' /m²' : yen(r.unitCost); tdU.dataset.key = r.name;
        const tdQ = document.createElement('td'); tdQ.className='right'; tdQ.textContent = r.isPerM2? r.qty.toLocaleString()+' m²' : '—';
        const tdT = document.createElement('td'); tdT.className='right'; tdT.textContent = yen(r.total);
        tr.append(tdN,tdU,tdQ,tdT); tbody.appendChild(tr);
      });

      $('#subHard').textContent = yen(subHard);
      $('#soft').textContent = yen(soft);
      $('#ff').textContent = yen(I.ffne);
      $('#appr').textContent = yen(I.approvals);
      $('#cont').textContent = yen(contingency);
      $('#total').textContent = yen(total);
      const usdVal = usd(total, I.fx);
      $('#totalUSD').textContent = (typeof usdVal === 'number')? usdVal.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}) : '—';

      history.replaceState(null,'', '#'+encodeURIComponent(JSON.stringify({...I, UC})))
    }

    // Inline edit mapping
    function attachInlineEdit(){
      $('#tbl').addEventListener('click', (e)=>{
        const td = e.target.closest('.editable');
        if(!td) return;
        const isPerM2 = td.textContent.includes('/m²');
        const cur = parseInt(td.textContent.replace(/[^0-9]/g,'')) || 0;
        const nv = prompt(`Enter new ${isPerM2? 'unit cost per m²':'fixed amount'} in JPY:`, cur);
        if(nv===null) return;
        const name = td.dataset.key || '';
        const val = +nv; if(!(val>0)) return;
        const kmap = [
          ['Base construction','base_'+($('#scope').value)+'_per_m2'],
          ['Seismic','seismic_per_m2'],
          ['MEP','mep_per_m2'],
          ['Exterior','ext_per_m2'],
          ['Interior','int_per_m2'],
          ['Insulation','insul_per_m2'],
          ['Fire','fire_per_m2'],
          ['Roof','roof_fixed'],
          ['Bathroom','bath_fixed'],
          ['Kitchen','kitchen_fixed'],
          ['Septic','septic_fixed'],
          ['Solar','solar_fixed'],
          ['Carport','carport_fixed'],
        ];
        for(const [needle,key] of kmap){ if(name.includes(needle)){ UC[key] = val; break; } }
        calc();
      });
    }

    function populateUC(){
      const body = $('#ucTable tbody'); body.innerHTML = '';
      const entries = [
        ['Base lite (per m²)','base_lite_per_m2'],
        ['Base mid (per m²)','base_mid_per_m2'],
        ['Base full (per m²)','base_full_per_m2'],
        ['Seismic (per m²)','seismic_per_m2'],
        ['MEP (per m²)','mep_per_m2'],
        ['Exterior (per m²)','ext_per_m2'],
        ['Interior (per m²)','int_per_m2'],
        ['Insulation/airtightness (per m²)','insul_per_m2'],
        ['Fire safety (per m²)','fire_per_m2'],
        ['Roof (fixed)','roof_fixed'],
        ['Bathroom (fixed)','bath_fixed'],
        ['Kitchen (fixed)','kitchen_fixed'],
        ['Septic / wastewater (fixed)','septic_fixed'],
        ['Solar PV 4–5kW (fixed)','solar_fixed'],
        ['Carport / parking (fixed)','carport_fixed'],
      ];
      entries.forEach(([label,key])=>{
        const tr=document.createElement('tr');
        const td1=document.createElement('td'); td1.textContent=label;
        const td2=document.createElement('td'); td2.className='right';
        const inp=document.createElement('input'); inp.type='number'; inp.value=UC[key]; inp.step='1000'; inp.style.width='140px'; inp.addEventListener('change',()=>{UC[key]=+inp.value; calc();});
        td2.appendChild(inp); tr.append(td1,td2); body.appendChild(tr);
      });
    }

    function resetAll(){
      UC = {...DEFAULTS};
      $('#area').value = 120; $('#scope').value = 'mid'; $('#region').value = '1.00'; $('#target').value = 'personal';
      $('#eq').checked = false; $('#roof').checked = true; $('#mep').checked = true; $('#bath').checked = true; $('#kitchen').checked = true; $('#fire').checked = false; $('#ext').checked = true; $('#int').checked = true; $('#insul').checked = true; $('#septic').checked = false; $('#solar').checked = false; $('#carport').checked = false;
      $('#profPct').value = 8; $('#contPct').value = 15; $('#ffne').value = 1500000; $('#approvals').value = 200000; $('#fx').value = 155;
      populateUC(); calc();
    }

    // Presets via localStorage
    function loadPresets(){
      const sel = $('#presets'); sel.innerHTML='';
      const keys = Object.keys(localStorage).filter(k=>k.startsWith('housePreset:'));
      const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='Load preset…'; sel.appendChild(opt0);
      keys.forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=k.replace('housePreset:',''); sel.appendChild(opt); });
      sel.addEventListener('change',()=>{
        const k=sel.value; if(!k) return;
        try{
          const data=JSON.parse(localStorage.getItem(k));
          if(data){
            Object.assign(UC,data.UC||{});
            for(const [id,val] of Object.entries(data.fields||{})){
              const el = document.getElementById(id); if(!el) continue; if(el.type==='checkbox') el.checked=!!val; else el.value=val;
            }
            populateUC(); calc();
          }
        }catch(e){console.error(e)}
      })
    }

    function savePreset(){
      const name = prompt('Preset name (e.g., "Kawazu house")'); if(!name) return;
      const fields = {};
      ['area','scope','region','target','profPct','contPct','ffne','approvals','fx'].forEach(id=>fields[id]=$('#'+id).value);
      ['eq','roof','mep','bath','kitchen','fire','ext','int','insul','septic','solar','carport'].forEach(id=>fields[id]=$('#'+id).checked);
      const data = {UC, fields}; localStorage.setItem('housePreset:'+name, JSON.stringify(data)); loadPresets();
    }

    function shareLink(){
      const hash = location.hash || '#'+encodeURIComponent(JSON.stringify({UC, ...readInputs()}));
      const url = location.origin + location.pathname + hash; navigator.clipboard?.writeText(url);
      alert('Copied shareable link with current assumptions to clipboard.');
    }

    function restoreDefaults(){ UC={...DEFAULTS}; populateUC(); calc(); }

    function hydrateFromHash(){
      if(!location.hash) return; try{
        const data = JSON.parse(decodeURIComponent(location.hash.slice(1)));
        if(data){ if(data.UC) UC = data.UC;
          const ids = ['area','scope','region','target','profPct','contPct','ffne','approvals','fx'];
          ids.forEach(id=>{ if(data[id]!==undefined){ const el=$('#'+id); if(el) el.value=data[id]; }});
          ;['eq','roof','mep','bath','kitchen','fire','ext','int','insul','septic','solar','carport'].forEach(id=>{ if(data[id]!==undefined){ $('#'+id).checked=!!data[id]; }});
        }
      }catch(e){ console.warn('Bad hash state'); }
    }

    // Events
    $('#calc').addEventListener('click', calc);
    $('#reset').addEventListener('click', resetAll);
    $('#share').addEventListener('click', shareLink);
    $('#save').addEventListener('click', savePreset);
    $('#restore').addEventListener('click', restoreDefaults);
    ['area','scope','region','target','profPct','contPct','ffne','approvals','fx'].forEach(id=>{ $('#'+id).addEventListener('change', calc); });
    ['eq','roof','mep','bath','kitchen','fire','ext','int','insul','septic','solar','carport'].forEach(id=>{ $('#'+id).addEventListener('change', calc); });

    attachInlineEdit(); populateUC(); hydrateFromHash(); calc(); loadPresets();
  </script>
</body>
</html>
